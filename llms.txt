# Belobog Stellar Grid

`belobog-stellar-grid` 是一个高性能的 WebAssembly 库，用于将 HTML 表格或 JavaScript 数据导出为 CSV 和 XLSX 文件。它专为处理大数据量设计，支持分批异步导出以避免阻塞浏览器主线程。

## 核心特性

- **高性能**: 基于 Rust 和 WebAssembly，速度极快。
- **大数据支持**: 支持分批异步导出，处理百万级数据不卡顿。
- **多格式**: 支持 CSV 和 Excel (Xlsx)。
- **丰富功能**: 支持合并单元格、多 Sheet 导出、树形数据导出（自动缩进）。
- **安全**: 内置文件名安全验证，防止路径遍历攻击，支持公式注入防护。
- **易用**: 提供统一的 API 和类型支持。
- **框架集成**: 提供 `@bsg-export/react` 和 `@bsg-export/vue` 官方封装组件。
- **Web Worker 支持**: `@bsg-export/worker` 将导出计算移至 Worker 线程，主线程不阻塞。
- **类型安全**: `@bsg-export/types` 提供严格的 TypeScript 类型定义。
- **质量保证**: 103 个单元测试，100% 测试覆盖，代码质量检查流程完善。

## 快速上手

```javascript
import init, { export_table, ExportFormat } from "belobog-stellar-grid";

await init();

// 简单导出
export_table("my-table-id", "data.csv");

// 导出 Excel 并显示进度
export_table("my-table-id", "report.xlsx", ExportFormat.Xlsx, false, (progress) => {
  console.log(`进度: ${progress}%`);
});
```

## API 参考

### 核心函数

#### `export_table(table_id, filename?, format?, exclude_hidden?, progress_callback?, with_bom?, strict_progress_callback?)`
统一导出函数，支持 DOM 表格导出。
- `table_id`: 表格 ID。
- `format`: `ExportFormat.Csv` 或 `ExportFormat.Xlsx`。
- `exclude_hidden`: 是否排除 `display: none` 的行列。
- `with_bom`: CSV 导出时是否添加 UTF-8 BOM（解决 Excel 中文乱码问题）。
- `strict_progress_callback`: 是否启用严格进度回调模式（回调失败会中断导出）。

#### `export_data(data, options?)`
直接导出 JS 数据（二维数组或对象数组）。
- `data`: `Array<Array<any>>` 或 `Array<Object>`。
- `options`: 配置对象，包含以下字段：
  - `columns`: `Array<ColumnConfig>`，表头配置数组，支持嵌套 children 实现多级表头
  - `filename`: `string`，导出文件名
  - `format`: `ExportFormat`，导出格式（Csv 或 Xlsx），默认 Csv
  - `progressCallback`: `Function(progress: number)`，进度回调函数，接收 0-100 的进度值
  - `indentColumn`: `string`，树形模式下需要缩进的列的 key
  - `childrenKey`: `string`，传入此参数启用树形数据模式，指定子节点字段名
  - `withBom`: `boolean`，CSV 导出时是否添加 UTF-8 BOM（解决 Excel 中文乱码问题），默认 false
  - `strictProgressCallback`: `boolean`，是否启用严格进度回调模式（回调失败会中断导出），默认 false
- 支持树形数据（通过 `childrenKey` 和 `indentColumn`）。
- 支持复杂表头和合并单元格（通过 `columns` 配置）。

#### `export_tables_xlsx(sheets, filename?, progress_callback?)`
导出多 Sheet Excel。
- `sheets`: 工作表配置数组，每个元素包含以下字段：
  - `tableId`: `string`，要导出的表格元素 ID
  - `sheetName`: `string`（可选），工作表名称，默认为 Sheet1、Sheet2...
  - `excludeHidden`: `boolean`（可选），是否排除隐藏行列，默认为 false
- `filename`: `string`（可选），导出文件名
- `progress_callback`: `Function(progress: number)`（可选），进度回调函数

#### `export_table_to_csv_batch(table_id, tbody_id?, filename?, batch_size?, exclude_hidden?, progress_callback?, with_bom?)`
异步分批导出 CSV，适用于大数据量（> 10k 行）。
- `table_id`: `string`，表格元素 ID
- `tbody_id`: `string`（可选），外部 tbody 元素 ID（用于虚拟滚动场景）
- `filename`: `string`（可选），导出文件名
- `batch_size`: `number`（可选），每批处理行数，默认 1000
- `exclude_hidden`: `boolean`（可选），是否排除隐藏行列，默认 false
- `progress_callback`: `Function(progress: number)`（可选），进度回调函数
- `with_bom`: `boolean`（可选），是否添加 UTF-8 BOM，默认 false

#### `export_table_to_xlsx_batch(table_id, tbody_id?, filename?, batch_size?, exclude_hidden?, progress_callback?)`
异步分批导出 XLSX，适用于大数据量（> 10k 行）。
- 参数同 `export_table_to_csv_batch`，但不支持 `with_bom` 参数

#### `export_tables_to_xlsx_batch(sheets, filename?, batch_size?, progress_callback?)`
多工作表分批异步导出 XLSX。
- `sheets`: 工作表配置数组，同 `export_tables_xlsx`
- 其他参数同 `export_table_to_xlsx_batch`

#### `generate_data_bytes(data, options?)`
与 `export_data` 功能相同，但返回文件字节（`Uint8Array`）而不触发下载。专为 Web Worker 场景设计。
- 参数同 `export_data`。
- 返回 `Uint8Array`。

### 类型

#### `ExportFormat`
- `Csv`: 0
- `Xlsx`: 1

## 框架集成包

### `@bsg-export/types` — 严格类型定义（零运行时）

提供 `Column`、`ExportDataOptions`、`SheetConfig`、`BatchSheetConfig`、`MergeCellValue` 等核心接口，以及所有导出函数的类型安全签名。

```typescript
import type { Column, ExportDataOptions } from '@bsg-export/types';
```

### `@bsg-export/react` — React 封装

- `useExporter()` Hook：自动 WASM 初始化 + loading/progress/error 状态 + 类型安全导出方法
- `<ExportButton>` 组件：开箱即用的导出按钮

```tsx
import { useExporter, ExportFormat } from '@bsg-export/react';

const { initialized, loading, progress, exportTable } = useExporter();
exportTable({ tableId: 'my-table', filename: '报表.xlsx', format: ExportFormat.Xlsx });
```

### `@bsg-export/vue` — Vue 3 封装

- `useExporter()` Composable：ref 响应式状态 + 导出方法
- `<ExportButton>` 组件：支持插槽和事件

```vue
<script setup>
import { useExporter, ExportFormat } from '@bsg-export/vue';
const { initialized, loading, progress, exportTable } = useExporter();
</script>
```

### `@bsg-export/worker` — Web Worker 导出封装

- `ExportWorker` 类：管理 Worker 生命周期、消息协议和文件下载
- React: `useWorkerExporter()` Hook
- Vue: `useWorkerExporter()` Composable

```typescript
import { ExportWorker } from '@bsg-export/worker';
const worker = new ExportWorker(myWorkerInstance);
await worker.init();
await worker.exportData(data, { columns, filename: '报表.xlsx', format: 1 });
worker.terminate();
```

## 开发指南

- 构建: `wasm-pack build --target web`
- 测试: `cargo test`
- 构建子包: `just build-packages`

## 常见问题

- **CSV 中文乱码**: 库会自动处理 BOM，通常 excel 打开正常。
- **内存限制**: 受限于浏览器 WASM 内存限制（通常 2GB-4GB），超大数据建议分批或服务端处理，但本库已通过流式/分批处理极大优化了内存占用。
