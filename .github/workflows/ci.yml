name: CI

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: æ£€æŸ¥ä»£ç æ ¼å¼
        run: cargo fmt -- --check

      - name: è¿è¡Œ Clippy
        run: cargo clippy -- -D warnings

      - name: è¿è¡Œæµ‹è¯•
        run: cargo test --lib --verbose

  # WebAssembly æ„å»º
  build-wasm:
    name: WebAssembly æ„å»º
    runs-on: ubuntu-latest
    needs: check

    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: å®‰è£… wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: æ„å»ºé¡¹ç›®
        run: cargo check --target wasm32-unknown-unknown --verbose

      - name: æ„å»º WebAssembly åŒ…
        run: wasm-pack build --target web --release

      - name: æ£€æŸ¥åŒ…å¤§å°
        run: |
          echo "WebAssembly æ–‡ä»¶å¤§å°:"
          ls -lh pkg/belobog_stellar_grid_bg.wasm

          PACKAGE_SIZE=$(stat -c%s pkg/belobog_stellar_grid_bg.wasm)
          echo "åŒ…å¤§å°: ${PACKAGE_SIZE} bytes"

          # WASM æ–‡ä»¶å¤§å°é™åˆ¶è°ƒæ•´ä¸º 1MBï¼ˆåŒ…å« xlsx æ”¯æŒåä½“ç§¯å¢å¤§ï¼‰
          if [ $PACKAGE_SIZE -gt 1024000 ]; then
            echo "âš ï¸ è­¦å‘Š: åŒ…å¤§å°è¶…è¿‡ 1MB"
          else
            echo "âœ… åŒ…å¤§å°åˆç†"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: wasm-package
          path: pkg/
          retention-days: 30

  # æµè§ˆå™¨æµ‹è¯•
  browser-test:
    name: æµè§ˆå™¨æµ‹è¯•
    runs-on: ubuntu-latest
    needs: build-wasm

    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½ WebAssembly åŒ…
        uses: actions/download-artifact@v4
        with:
          name: wasm-package
          path: pkg/

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: åˆ›å»ºæµ‹è¯•é¡µé¢
        run: |
          # å°†æµ‹è¯•é¡µé¢æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œæ–¹ä¾¿å¼•ç”¨ pkg/
          cat > test-page.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>WebAssembly æµ‹è¯•</title>
          </head>
          <body>
            <h1>WebAssembly åŠŸèƒ½æµ‹è¯•</h1>
            <table id="test-table">
              <tr><td>æµ‹è¯•æ•°æ®1</td><td>æµ‹è¯•æ•°æ®2</td></tr>
              <tr><td>æµ‹è¯•æ•°æ®3</td><td>æµ‹è¯•æ•°æ®4</td></tr>
            </table>
            <button id="test-btn">è¿è¡Œæµ‹è¯•</button>
            <div id="result"></div>

            <script type="module">
              import init, { export_table } from './pkg/belobog_stellar_grid.js';

              document.getElementById('test-btn').addEventListener('click', async () => {
                try {
                  await init();
                  export_table('test-table', 'test.csv');
                  document.getElementById('result').innerHTML =
                    '<div style="color: green;">âœ… æµ‹è¯•æˆåŠŸ</div>';
                } catch (error) {
                  document.getElementById('result').innerHTML =
                    '<div style="color: red;">âŒ æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
                }
              });
            </script>
          </body>
          </html>
          EOF

      - name: åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•
        run: |
          # å®‰è£…æµ‹è¯•ä¾èµ–
          npm install puppeteer http-server

          # å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼ˆåå°è¿è¡Œï¼‰
          npx http-server . -p 8080 --silent &
          SERVER_PID=$!
          sleep 2

          # è¿è¡Œ Puppeteer æµ‹è¯•
          node << 'SCRIPT'
          const puppeteer = require('puppeteer');

          (async () => {
            const browser = await puppeteer.launch({
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();

            // ç›‘å¬æ§åˆ¶å°æ¶ˆæ¯
            page.on('console', msg => {
              console.log('Browser console:', msg.text());
            });

            page.on('pageerror', error => {
              console.error('Page error:', error.message);
            });

            try {
              await page.goto('http://localhost:8080/test-page.html', { waitUntil: 'networkidle0' });

              // ç­‰å¾…é¡µé¢åŠ è½½
              await page.waitForSelector('h1');

              // ç‚¹å‡»æµ‹è¯•æŒ‰é’®
              await page.click('#test-btn');

              // ç­‰å¾…æµ‹è¯•ç»“æœ
              await page.waitForSelector('#result div', { timeout: 10000 });

              const result = await page.$eval('#result', el => el.textContent);
              console.log('Test result:', result);

              await browser.close();

              if (result.includes('æµ‹è¯•æˆåŠŸ')) {
                console.log('âœ… WebAssembly æµ‹è¯•é€šè¿‡');
                process.exit(0);
              } else {
                console.log('âŒ WebAssembly æµ‹è¯•å¤±è´¥');
                process.exit(1);
              }
            } catch (error) {
              console.error('Test error:', error.message);
              await browser.close();
              process.exit(1);
            }
          })();
          SCRIPT

          # æ¸…ç† HTTP æœåŠ¡å™¨
          kill $SERVER_PID 2>/dev/null || true

  # å‘å¸ƒåˆ° npm
  publish-npm:
    name: å‘å¸ƒåˆ° npm
    runs-on: ubuntu-latest
    needs: [check, build-wasm, browser-test]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½ WebAssembly åŒ…
        uses: actions/download-artifact@v4
        with:
          name: wasm-package
          path: pkg/

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          registry-url: "https://registry.npmjs.org"

      - name: æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')
          echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"

          # æ£€æŸ¥ Cargo.toml ç‰ˆæœ¬
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | cut -d '"' -f 2)
          if [ "$VERSION" != "$CARGO_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬ä¸ä¸€è‡´: Git=$VERSION, Cargo=$CARGO_VERSION"
            exit 1
          fi

          echo "âœ… ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"

      - name: å‡†å¤‡å‘å¸ƒ
        working-directory: pkg
        run: |
          # ç¡®ä¿ package.json å­˜åœ¨
          if [ ! -f package.json ]; then
            echo "âŒ pkg/package.json ä¸å­˜åœ¨"
            exit 1
          fi

          # æ˜¾ç¤ºåŒ…ä¿¡æ¯
          echo "ğŸ“¦ åŒ…ä¿¡æ¯:"
          cat package.json

          echo ""
          echo "ğŸ“‚ åŒ…å†…å®¹:"
          ls -la

      - name: å‘å¸ƒåˆ° npm
        working-directory: pkg
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')
          echo "ğŸ‰ æˆåŠŸå‘å¸ƒ belobog-stellar-grid@$VERSION åˆ° npm!"
          echo "ğŸ“¦ https://www.npmjs.com/package/belobog-stellar-grid"

  # åˆ›å»º GitHub Release
  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    needs: [check, build-wasm, browser-test]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: æå–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ğŸ“Œ ç‰ˆæœ¬å·: $VERSION"

      - name: ä» CHANGELOG.md æå–å‘å¸ƒè¯´æ˜
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # æå–å¯¹åº”ç‰ˆæœ¬çš„å†…å®¹ï¼ˆä¸¤ä¸ª ## [ æ ‡é¢˜ä¹‹é—´ï¼Œæˆ–åˆ°æ–‡ä»¶æœ«å°¾ï¼‰
          NOTES=$(awk -v ver="$VERSION" '
            /^## \[/ {
              if (found) exit
              if (index($0, "[" ver "]")) found=1
              next
            }
            found { print }
          ' CHANGELOG.md)

          if [ -z "$NOTES" ]; then
            echo "âš ï¸ æœªåœ¨ CHANGELOG.md ä¸­æ‰¾åˆ°ç‰ˆæœ¬ $VERSION çš„è®°å½•ï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜"
            NOTES="å‘å¸ƒç‰ˆæœ¬ v${VERSION}"
          fi

          # å†™å…¥å¤šè¡Œè¾“å‡º
          {
            echo "notes<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: wasm-package
          path: pkg/

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: false
          files: |
            pkg/belobog_stellar_grid_bg.wasm
            pkg/belobog_stellar_grid.js
            pkg/belobog_stellar_grid.d.ts
