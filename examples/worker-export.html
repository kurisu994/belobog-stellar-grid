<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Worker å¯¼å‡ºç¤ºä¾‹ - belobog-stellar-grid</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 40px 20px;
            background: linear-gradient(135deg, #0F2027 0%, #203A43 50%, #2C5364 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 32px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        .section { margin-bottom: 40px; }
        .section h2 { color: #444; margin-bottom: 15px; font-size: 20px; border-left: 4px solid #2C5364; padding-left: 12px; }
        .section p { color: #666; margin-bottom: 15px; line-height: 1.6; }
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        button {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 160px;
        }
        .btn-worker {
            background: linear-gradient(135deg, #0F2027 0%, #2C5364 100%);
            color: white;
        }
        .btn-worker:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44,83,100,0.4);
        }
        .btn-main {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .info-box {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            color: #0050b3;
            font-size: 14px;
        }
        .info-box strong { color: #003a8c; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #0F2027, #2C5364);
            border-radius: 4px;
            transition: width 0.1s;
            width: 0%;
        }
        #status { color: #666; font-size: 14px; margin-top: 8px; min-height: 20px; }
        .comparison { display: flex; gap: 20px; margin-top: 15px; }
        .comparison .col { flex: 1; }
        .comparison .col h3 { font-size: 14px; color: #999; margin-bottom: 8px; }
        .comparison .result {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            min-height: 36px;
        }
        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .keyword { color: #c678dd; }
        .string { color: #98c379; }
        .comment { color: #5c6370; font-style: italic; }
        .func { color: #61afef; }
        .number { color: #d19a66; }
        .code { background: #e8f0fe; padding: 2px 8px; border-radius: 3px; font-family: 'Courier New', monospace; color: #5f6368; }
        .ticker-box {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .ticker-counter {
            font-size: 32px;
            font-weight: 700;
            color: #2C5364;
            font-family: 'Courier New', monospace;
            min-width: 80px;
        }
        .ticker-label {
            font-size: 12px;
            color: #999;
        }
        .ticker-input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            width: 200px;
        }
        .ticker-input:focus {
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¡ Web Worker å¯¼å‡º</h1>
        <p class="subtitle">
            ä½¿ç”¨ <span class="code">generate_data_bytes()</span> åœ¨ Worker çº¿ç¨‹ä¸­ç”Ÿæˆæ–‡ä»¶ï¼Œä¸»çº¿ç¨‹å§‹ç»ˆä¿æŒå“åº”ã€‚
        </p>

        <div class="info-box">
            <strong>ğŸ’¡ æ ¸å¿ƒåŸç†ï¼š</strong>
            WASM çš„ CSV/XLSX åºåˆ—åŒ–åœ¨ Worker çº¿ç¨‹æ‰§è¡Œï¼Œç”Ÿæˆçš„å­—èŠ‚é€šè¿‡ Transferable é›¶æ‹·è´ä¼ å›ä¸»çº¿ç¨‹è§¦å‘ä¸‹è½½ã€‚
            ä¸‹æ–¹çš„è®¡æ—¶å™¨å’Œè¾“å…¥æ¡†éƒ½ä¾èµ–ä¸»çº¿ç¨‹ â€” ä¸»çº¿ç¨‹é˜»å¡æ—¶å®ƒä»¬ä¼šåŒæ—¶å†»ç»“ã€‚
        </div>

        <!-- Worker å¯¼å‡º vs ä¸»çº¿ç¨‹å¯¼å‡ºå¯¹æ¯” -->
        <div class="section">
            <h2>Worker å¯¼å‡º vs ä¸»çº¿ç¨‹å¯¼å‡º</h2>
            <p>ç”Ÿæˆ 200000 è¡Œæ•°æ®å¹¶å¯¼å‡ºï¼Œå¯¹æ¯” Worker å’Œä¸»çº¿ç¨‹çš„æ€§èƒ½å·®å¼‚ï¼š</p>

            <div class="ticker-box">
                <div>
                    <div class="ticker-counter" id="ticker">0</div>
                    <div class="ticker-label">JS è®¡æ—¶å™¨ï¼ˆæ¯ 50ms +1ï¼‰</div>
                </div>
                <div>
                    <input class="ticker-input" id="test-input" placeholder="è¯•è¯•åœ¨å¯¼å‡ºæ—¶è¾“å…¥æ–‡å­—..." />
                    <div class="ticker-label">â†‘ ä¸»çº¿ç¨‹é˜»å¡æ—¶æ— æ³•è¾“å…¥</div>
                </div>
            </div>

            <div class="progress-bar"><div class="progress-bar-fill" id="progress-fill"></div></div>
            <div id="status">å°±ç»ª</div>

            <div class="comparison">
                <div class="col">
                    <h3>ğŸ§µ Worker çº¿ç¨‹</h3>
                    <div class="result" id="worker-time">-</div>
                </div>
                <div class="col">
                    <h3>ğŸ”´ ä¸»çº¿ç¨‹</h3>
                    <div class="result" id="main-time">-</div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-worker" id="btn-worker" onclick="workerExport()">âš¡ Worker å¯¼å‡º 200000 è¡Œ XLSX</button>
                <button class="btn-main" id="btn-main" onclick="mainThreadExport()">ğŸ”´ ä¸»çº¿ç¨‹å¯¼å‡º 200000 è¡Œ XLSX</button>
            </div>
        </div>

        <!-- ä»£ç ç¤ºä¾‹ -->
        <div class="section">
            <h2>ğŸ’¡ ä½¿ç”¨æ–¹å¼</h2>
<pre><span class="comment">// 1. ä½å±‚ APIï¼šç›´æ¥åœ¨ Worker ä¸­ä½¿ç”¨ generate_data_bytes()</span>
<span class="comment">// worker.js:</span>
<span class="keyword">import</span> init, { generate_data_bytes, ExportFormat } <span class="keyword">from</span> <span class="string">'belobog-stellar-grid'</span>;
<span class="keyword">await</span> <span class="func">init</span>();

self.<span class="func">addEventListener</span>(<span class="string">'message'</span>, (e) => {
    <span class="keyword">const</span> bytes = <span class="func">generate_data_bytes</span>(e.data.data, e.data.options);
    self.<span class="func">postMessage</span>({ bytes: bytes.buffer }, [bytes.buffer]);
});

<span class="comment">// 2. é«˜å±‚ APIï¼šä½¿ç”¨ @bsg-export/worker çš„ ExportWorker ç±»</span>
<span class="keyword">import</span> { ExportWorker } <span class="keyword">from</span> <span class="string">'@bsg-export/worker'</span>;
<span class="keyword">import</span> MyWorker <span class="keyword">from</span> <span class="string">'@bsg-export/worker/worker?worker'</span>;

<span class="keyword">const</span> worker = <span class="keyword">new</span> <span class="func">ExportWorker</span>(<span class="keyword">new</span> <span class="func">MyWorker</span>());
<span class="keyword">await</span> worker.<span class="func">init</span>();
<span class="keyword">await</span> worker.<span class="func">exportData</span>(data, { columns, filename: <span class="string">'æŠ¥è¡¨.xlsx'</span>, format: <span class="number">1</span> });
worker.<span class="func">terminate</span>();</pre>
        </div>
    </div>

    <script type="module">
        import init, { export_data, generate_data_bytes, ExportFormat } from '../pkg/belobog_stellar_grid.js';

        await init();

        const statusEl = document.getElementById('status');
        const progressFill = document.getElementById('progress-fill');
        const workerTimeEl = document.getElementById('worker-time');
        const mainTimeEl = document.getElementById('main-time');

        // ç”Ÿæˆæµ‹è¯•æ•°æ®
        function generateData(count) {
            const depts = ['æŠ€æœ¯éƒ¨', 'äº§å“éƒ¨', 'è®¾è®¡éƒ¨', 'å¸‚åœºéƒ¨', 'äººåŠ›èµ„æºéƒ¨', 'è´¢åŠ¡éƒ¨'];
            const data = [];
            for (let i = 1; i <= count; i++) {
                data.push({
                    id: i,
                    name: `ç”¨æˆ·_${i}`,
                    email: `user${i}@example.com`,
                    dept: depts[i % depts.length],
                    salary: Math.floor(Math.random() * 30000) + 10000,
                    date: `2024-${String((i % 12) + 1).padStart(2, '0')}-${String((i % 28) + 1).padStart(2, '0')}`,
                });
            }
            return data;
        }

        const columns = [
            { title: 'åºå·', key: 'id' },
            { title: 'ç”¨æˆ·å', key: 'name' },
            { title: 'é‚®ç®±', key: 'email' },
            { title: 'éƒ¨é—¨', key: 'dept' },
            { title: 'è–ªèµ„', key: 'salary' },
            { title: 'å…¥èŒæ—¥æœŸ', key: 'date' },
        ];

        // Worker å¯¼å‡º
        window.workerExport = async () => {
            const btn = document.getElementById('btn-worker');
            btn.disabled = true;
            statusEl.textContent = 'â³ ç”Ÿæˆæ•°æ®ä¸­...';
            progressFill.style.width = '0%';

            const data = generateData(200000);
            statusEl.textContent = 'â³ Worker å¯¼å‡ºä¸­...';

            const start = performance.now();

            // ä½¿ç”¨å†…è” Workerï¼ˆå®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨ç‹¬ç«‹æ–‡ä»¶ï¼‰
            const workerCode = `
                import init, { generate_data_bytes } from '${new URL('../pkg/belobog_stellar_grid.js', location.href).href}';
                await init();
                self.addEventListener('message', (e) => {
                    try {
                        const bytes = generate_data_bytes(e.data.data, e.data.options);
                        self.postMessage({ type: 'result', bytes: bytes.buffer }, [bytes.buffer]);
                    } catch (err) {
                        self.postMessage({ type: 'error', message: String(err) });
                    }
                });
                self.postMessage({ type: 'ready' });
            `;
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(blob);
            const worker = new Worker(workerUrl, { type: 'module' });

            worker.addEventListener('message', (e) => {
                if (e.data.type === 'ready') {
                    worker.postMessage({
                        data,
                        options: {
                            columns,
                            format: 1, // ExportFormat.Xlsx
                        },
                    });
                } else if (e.data.type === 'result') {
                    const elapsed = (performance.now() - start).toFixed(0);
                    workerTimeEl.textContent = `${elapsed}ms`;
                    progressFill.style.width = '100%';
                    statusEl.textContent = `âœ… Worker å¯¼å‡ºå®Œæˆ (${elapsed}ms)`;

                    // è§¦å‘ä¸‹è½½
                    const fileBlob = new Blob([e.data.bytes], {
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    });
                    const url = URL.createObjectURL(fileBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'worker_200000è¡Œ.xlsx';
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(url), 10000);

                    worker.terminate();
                    URL.revokeObjectURL(workerUrl);
                    btn.disabled = false;
                } else if (e.data.type === 'error') {
                    statusEl.textContent = `âŒ é”™è¯¯: ${e.data.message}`;
                    worker.terminate();
                    btn.disabled = false;
                }
            });
        };

        // ä¸»çº¿ç¨‹å¯¼å‡º
        window.mainThreadExport = () => {
            const btn = document.getElementById('btn-main');
            btn.disabled = true;
            statusEl.textContent = 'â³ ç”Ÿæˆæ•°æ®ä¸­...';
            progressFill.style.width = '0%';

            const data = generateData(200000);
            statusEl.textContent = 'ğŸ”´ ä¸»çº¿ç¨‹å¯¼å‡ºä¸­ï¼ˆé¡µé¢å¯èƒ½å¡é¡¿ï¼‰...';

            // ä½¿ç”¨ requestAnimationFrame ä¿è¯ UI æ›´æ–°åå†æ‰§è¡Œ
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    const start = performance.now();
                    try {
                        export_data(data, {
                            columns,
                            filename: 'ä¸»çº¿ç¨‹_200000è¡Œ.xlsx',
                            format: ExportFormat.Xlsx,
                            progressCallback: (p) => {
                                progressFill.style.width = `${p}%`;
                            },
                        });
                        const elapsed = (performance.now() - start).toFixed(0);
                        mainTimeEl.textContent = `${elapsed}ms`;
                        progressFill.style.width = '100%';
                        statusEl.textContent = `âœ… ä¸»çº¿ç¨‹å¯¼å‡ºå®Œæˆ (${elapsed}ms) â€” æ³¨æ„åŠ¨ç”»æ˜¯å¦å¡é¡¿`;
                    } catch (e) {
                        statusEl.textContent = `âŒ é”™è¯¯: ${e}`;
                    }
                    btn.disabled = false;
                });
            });
        };

        // JS è®¡æ—¶å™¨ â€” ä¾èµ–ä¸»çº¿ç¨‹ï¼Œé˜»å¡æ—¶ä¼šå†»ç»“
        let tickCount = 0;
        setInterval(() => {
            tickCount++;
            document.getElementById('ticker').textContent = tickCount;
        }, 50);

        console.log('ğŸš€ WebAssembly å·²åˆå§‹åŒ–ï¼ŒWorker å¯¼å‡ºç¤ºä¾‹å¯ç”¨');
    </script>
</body>
</html>
